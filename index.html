<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hybrid People Counter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 0; background: #fafafa; }
    video, canvas {
      width: 100%;
      max-width: 640px;
      border: 2px solid #444;
      border-radius: 8px;
      margin-top: 10px;
    }
    .controls { margin-top: 10px; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; border-radius: 6px; border: none; cursor: pointer; }
    .counter {
      margin-top: 15px;
      font-size: 20px;
      font-weight: bold;
      background: #fff;
      display: inline-block;
      padding: 10px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    #peopleCount { margin-top: 10px; font-size: 18px; color: #333; }
  </style>
</head>
<body>
  <h2>Hybrid People Counter</h2>
  <div class="controls">
    <button onclick="startCamera('environment')">üì∑ Kamera Belakang</button>
    <button onclick="startCamera('user')">ü§≥ Kamera Depan</button>
    <button onclick="stopCamera()">‚õî Stop Kamera</button>
    <button onclick="resetCounter()">üîÑ Reset Counter</button>
  </div>

  <video id="video" playsinline></video>
  <canvas id="canvas"></canvas>

  <div class="counter">
    Masuk: <span id="countIn">0</span> | 
    Keluar: <span id="countOut">0</span>
  </div>
  <p id="peopleCount">Orang terdeteksi: 0</p>
  <p id="status">‚è≥ Menunggu pilihan kamera...</p>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    let detector; // MoveNet
    let faceDetection; // MediaPipe
    let usePose = true;

    let countIn = 0, countOut = 0;
    let prevCenters = [];
    let cameraObj = null;

    function updateCounter(inVal, outVal) {
      countIn += inVal;
      countOut += outVal;
      document.getElementById("countIn").innerText = countIn;
      document.getElementById("countOut").innerText = countOut;
    }

    function resetCounter() {
      countIn = 0;
      countOut = 0;
      document.getElementById("countIn").innerText = countIn;
      document.getElementById("countOut").innerText = countOut;
      console.log("üîÑ Counter di-reset manual");
    }

    function processCenters(centers) {
      centers.forEach(c => {
        prevCenters.forEach(p => {
          const dx = c.x - p.x;
          if (Math.abs(dx) > 40) {
            if (p.x < canvas.width * 0.3 && c.x > canvas.width * 0.7) {
              updateCounter(0, 1); // keluar
            }
            if (p.x > canvas.width * 0.7 && c.x < canvas.width * 0.3) {
              updateCounter(1, 0); // masuk
            }
          }
        });
      });
      prevCenters = centers;
    }

    function drawHelpers() {
      ctx.strokeStyle = "blue";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(canvas.width * 0.3, 0);
      ctx.lineTo(canvas.width * 0.3, canvas.height);
      ctx.stroke();

      ctx.strokeStyle = "green";
      ctx.beginPath();
      ctx.moveTo(canvas.width * 0.7, 0);
      ctx.lineTo(canvas.width * 0.7, canvas.height);
      ctx.stroke();
    }

    function getCenterHip(keypoints) {
      const leftHip = keypoints[23];
      const rightHip = keypoints[24];
      if (leftHip && rightHip && leftHip.score > 0.2 && rightHip.score > 0.2) {
        return {
          x: (leftHip.x + rightHip.x) / 2,
          y: (leftHip.y + rightHip.y) / 2
        };
      }
      return null;
    }

    async function detectPose() {
      if (!detector) return;
      const poses = await detector.estimatePoses(video);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      drawHelpers();

      let centers = [];
      poses.forEach(pose => {
        const c = getCenterHip(pose.keypoints);
        if (c) {
          centers.push(c);
          ctx.fillStyle = "red";
          ctx.beginPath();
          ctx.arc(c.x, c.y, 6, 0, 2 * Math.PI);
          ctx.fill();
        }
      });

      if (centers.length > 0) {
        document.getElementById("peopleCount").innerText = "Orang terdeteksi: " + centers.length;
        processCenters(centers);
      } else {
        usePose = false; // fallback
      }

      if (cameraObj) requestAnimationFrame(() => { if (usePose) detectPose(); });
    }

    function onFaceResults(results) {
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
      drawHelpers();

      let centers = [];
      results.detections.forEach(d => {
        const box = d.locationData.relativeBoundingBox;
        const x = (box.xmin + box.width / 2) * canvas.width;
        const y = (box.ymin + box.height / 2) * canvas.height;
        centers.push({ x, y });

        ctx.strokeStyle = "orange";
        ctx.strokeRect(box.xmin * canvas.width, box.ymin * canvas.height,
                       box.width * canvas.width, box.height * canvas.height);
        ctx.fillStyle = "blue";
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, 2 * Math.PI);
        ctx.fill();
      });

      if (centers.length > 0) {
        document.getElementById("peopleCount").innerText = "Orang terdeteksi: " + centers.length;
        processCenters(centers);
        usePose = true; // balik ke pose lagi
      }

      if (!usePose && cameraObj) requestAnimationFrame(() => faceDetection.send({ image: video }));
    }

    async function initModels() {
      if (!detector) {
        const detectorConfig = {
          modelType: poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING
        };
        detector = await poseDetection.createDetector(
          poseDetection.SupportedModels.MoveNet,
          detectorConfig
        );
      }

      if (!faceDetection) {
        faceDetection = new FaceDetection.FaceDetection({
          locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`
        });
        faceDetection.setOptions({ model: 'short', minDetectionConfidence: 0.5 });
        faceDetection.onResults(onFaceResults);
      }

      document.getElementById("status").innerText = "‚úÖ Model siap";
    }

    async function startCamera(facingMode) {
      stopCamera(); // pastikan kamera lama mati dulu
      await initModels();

      cameraObj = new Camera(video, {
        onFrame: async () => {
          if (usePose) {
            await detectPose();
          } else {
            await faceDetection.send({ image: video });
          }
        },
        facingMode: facingMode,
        width: 640,
        height: 480
      });
      cameraObj.start();

      video.onloadedmetadata = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
      };

      document.getElementById("status").innerText = "üì∑ Kamera aktif (" + facingMode + ")";
    }

    function stopCamera() {
      if (cameraObj) {
        cameraObj.stop();
        cameraObj = null;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.getElementById("status").innerText = "‚õî Kamera dihentikan";
        document.getElementById("peopleCount").innerText = "Orang terdeteksi: 0";
      }
    }
  </script>
</body>
</html>
